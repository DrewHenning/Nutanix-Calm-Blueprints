{"api_version":"3.0","metadata":{"creation_time":"1544134681114840","kind":"blueprint","last_update_time":"1544483698643610","name":"Windows Server 2016 Deployment - DHCP","spec_version":48},"spec":{"description":"Automated deployment of Windows Server 2016","name":"Windows Server 2016 Deployment - DHCP","resources":{"app_profile_list":[{"action_list":[],"deployment_create_list":[{"action_list":[],"depends_on_list":[],"description":"","max_replicas":"1","min_replicas":"1","name":"19082c6d_deployment","package_local_reference_list":[{"kind":"app_package","name":"Package1"}],"published_service_local_reference_list":[],"substrate_local_reference":{"kind":"app_substrate","name":"WinSrv16"},"type":"GREENFIELD","variable_list":[]}],"description":"","name":"Windows Server 2016 App","variable_list":[{"attrs":{"type":""},"description":"","editables":{"value":true},"label":"","name":"AD_Domain_Name","type":"LOCAL","val_type":"STRING","value":"supernuc.lab"},{"attrs":{"is_secret_modified":false,"secret_reference":{},"type":""},"description":"","editables":{"value":true},"label":"","name":"AD_Join_Password","type":"SECRET","val_type":"STRING","value":""},{"attrs":{"type":""},"description":"","editables":{"value":true},"label":"","name":"AD_Join_User","type":"LOCAL","val_type":"STRING","value":"supernuc\\administrator"},{"attrs":{"type":""},"description":"","editables":{"value":true},"label":"","name":"AD_OU","type":"LOCAL","val_type":"STRING","value":"OU=NTNX Servers,DC=supernuc,DC=lab"},{"attrs":{"type":""},"description":"","editables":{"value":true},"label":"","name":"CD_Drive_Letter","type":"LOCAL","val_type":"STRING","value":"Z:"},{"attrs":{"type":""},"description":"","editables":{"value":true},"label":"","name":"Data_Drive_Label","type":"LOCAL","val_type":"STRING","value":"DATA"},{"attrs":{"type":""},"description":"","editables":{"value":true},"label":"","name":"Data_Drive_Letter","type":"LOCAL","val_type":"STRING","value":"D"},{"attrs":{"is_secret_modified":false,"secret_reference":{},"type":""},"description":"","editables":{"value":true},"label":"","name":"Local_Admin_Password","type":"SECRET","val_type":"STRING","value":""}]}],"client_attrs":{"19082c6d_deployment":{"x":279.4216346679,"y":36.3140797045},"743a9224-5f5c-c7b1-8097-612d6258fc9e":{"x":801.9806537648,"y":575.096227539}},"credential_definition_list":[{"description":"","name":"Windows Local Admin","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"type":"PASSWORD","username":"administrator"}],"default_credential_local_reference":{"kind":"app_credential","name":"Windows Local Admin"},"package_definition_list":[{"action_list":[],"description":"","name":"Package1","options":{"install_runbook":{"description":"","main_task_local_reference":{"kind":"app_task","name":"b9592ed2_dag"},"message_list":[],"name":"9882fa34_runbook","state":"ACTIVE","task_definition_list":[{"attrs":{"command_line_args":"","exit_status":[],"login_credential_local_reference":{"kind":"app_credential","name":"Windows Local Admin"},"script":"##############################################\n# Name        : JoinDomain.ps1\n# Author      : K Sarat Kumar\n# Version     : 1.0\n# Description : Script is used to Change hostname of machines and join to domain.\n##############################################\n$HOSTNAME = \"@@{calm_application_name}@@\"\n\nfunction Set-Hostname{\n  [CmdletBinding()]\n  Param(\n      [parameter(Mandatory=$true)]\n      [string]$Hostname\n)\n  if ($Hostname -eq  $(hostname)){\n    Write-Host \"Hostname already set.\"\n  } else{\n    Rename-Computer -NewName $HOSTNAME -ErrorAction Stop\n  }\n}\n\nfunction JointoDomain {\n  [CmdletBinding()]\n  Param(\n      [parameter(Mandatory=$true)]\n      [string]$DomainName,\n      [parameter(Mandatory=$false)]\n      [string]$OU,\n      [parameter(Mandatory=$true)]\n      [string]$Username,\n      [parameter(Mandatory=$true)]\n      [string]$Password,\n      [parameter(Mandatory=$false)]\n      [string]$Server\n  )\n  #$adapter = Get-NetAdapter | ? {$_.Status -eq \"up\"}\n  #$adapter | Set-DnsClientServerAddress -ServerAddresses $Server\n\nif ($env:computername -eq $env:userdomain) {\n    Write-Host \"Not in domain\"\n    $adminname = \"$Username\"\n    $adminpassword = ConvertTo-SecureString -asPlainText -Force -String \"$Password\"\n    Write-Host \"$adminname , $password\"\n    $credential = New-Object System.Management.Automation.PSCredential($adminname,$adminpassword)\n    Add-computer -DomainName $DomainName -OUPath $OU -Credential $credential -force -Options JoinWithNewName,AccountCreate -PassThru -ErrorAction Stop\n  } else {\n     Write-Host \"Already in domain\"\n  }\n}\n\nif ($HOSTNAME -ne $Null){\n  Write-Host \"Setting Hostname\"\n  Set-Hostname -Hostname $HOSTNAME\n}\n\nJointoDomain -DomainName \"@@{AD_Domain_Name}@@\" -Username \"@@{AD_Join_User}@@\" -Password \"@@{AD_Join_Password}@@\" -OU \"@@{AD_OU}@@\"\n\nRestart-Computer -Force -AsJob\nexit 0\n","script_type":"npsscript","type":""},"child_tasks_local_reference_list":[],"description":"","message_list":[],"name":"AD Domain Join","retries":"0","state":"ACTIVE","target_any_local_reference":{"kind":"app_service","name":"Windows Server 2016 VM"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"attrs":{"command_line_args":"","exit_status":[],"login_credential_local_reference":{"kind":"app_credential","name":"Windows Local Admin"},"script":"$NewDrvLetter=\"@@{CD_Drive_Letter}@@\"\n\n# Get Available CD\/DVD Drive - Drive Type 5\n$DvdDrv = Get-WmiObject -Class Win32_Volume -Filter \"DriveType=5\"\n\n# Check if CD\/DVD Drive is Available\nif ($DvdDrv -ne $null) {\n\n  # Get Current Drive Letter for CD\/DVD Drive\n  $DvdDrvLetter = $DvdDrv | Select-Object -ExpandProperty DriveLetter\n  Write-Output \"Current CD\/DVD Drive Letter is $DvdDrvLetter\"\n\n  # Confirm New Drive Letter is NOT used\n  if (-not (Test-Path -Path $NewDrvLetter)) {\n  \n    # Change CD\/DVD Drive Letter\n    $DvdDrv | Set-WmiInstance -Arguments @{DriveLetter=\"$NewDrvLetter\"}\n    Write-Output \"Updated CD\/DVD Drive Letter as $NewDrvLetter\"\n  }\n  else {\n    Write-Output \"Error: Drive Letter $NewDrvLetter Already In Use\"\n  }\n}\nelse {\n  Write-Output \"Error: No CD\/DVD Drive Available !!\"\n}\n","script_type":"npsscript","type":""},"child_tasks_local_reference_list":[],"description":"","message_list":[],"name":"Change CDROM Drive Letter","retries":"0","state":"ACTIVE","target_any_local_reference":{"kind":"app_service","name":"Windows Server 2016 VM"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"attrs":{"command_line_args":"","exit_status":[],"login_credential_local_reference":{"kind":"app_credential","name":"Windows Local Admin"},"script":"$sh = New-Object -ComObject \"Shell.Application\"\n$sh.Namespace(17).Items() | \n    Where-Object { $_.Type -eq \"CD Drive\" } | \n        foreach { $_.InvokeVerb(\"Eject\") }","script_type":"npsscript","type":""},"child_tasks_local_reference_list":[],"description":"","message_list":[],"name":"Eject CDROM ISO","retries":"0","state":"ACTIVE","target_any_local_reference":{"kind":"app_service","name":"Windows Server 2016 VM"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"attrs":{"command_line_args":"","exit_status":[],"login_credential_local_reference":{"kind":"app_credential","name":"Windows Local Admin"},"script":"$start_time = Get-Date\n\nGet-Disk -Number 1 | Initialize-Disk -ErrorAction SilentlyContinue\n#  Get-Disk -Number 2 | Initialize-Disk -ErrorAction SilentlyContinue\n#  Get-Disk -Number 3 | Initialize-Disk -ErrorAction SilentlyContinue\n#  Get-Disk -Number 4 | Initialize-Disk -ErrorAction SilentlyContinue\n#  Get-Disk -Number 5 | Initialize-Disk -ErrorAction SilentlyContinue\n#  Get-Disk -Number 6 | Initialize-Disk -ErrorAction SilentlyContinue\n#  Get-Disk -Number 7 | Initialize-Disk -ErrorAction SilentlyContinue\n#  Get-Disk -Number 8 | Initialize-Disk -ErrorAction SilentlyContinue\n\n# Format Data disk\n  New-Partition -DiskNumber 1 -DriveLetter \"@@{Data_Drive_Letter}@@\" -UseMaximumSize -ErrorAction SilentlyContinue | Format-Volume -Confirm:$false\n\n  # Format SQL backup\/restore disk\n  #New-Partition -DiskNumber 2 -DriveLetter R -UseMaximumSize -ErrorAction SilentlyContinue | Format-Volume -Confirm:$false\n\n  # Format DB DATA drives\n#  New-Partition -DiskNumber 3 -DriveLetter G -UseMaximumSize -ErrorAction SilentlyContinue | Format-Volume -Confirm:$false\n#  New-Partition -DiskNumber 4 -DriveLetter H -UseMaximumSize -ErrorAction SilentlyContinue | Format-Volume -Confirm:$false\n\n  # Format DB TEMP drives\n#  New-Partition -DiskNumber 5 -DriveLetter I -UseMaximumSize -ErrorAction SilentlyContinue | Format-Volume -Confirm:$false\n # New-Partition -DiskNumber 6 -DriveLetter J -UseMaximumSize -ErrorAction SilentlyContinue | Format-Volume -Confirm:$false\n\n  # Format DB LOGS drives\n # New-Partition -DiskNumber 7 -DriveLetter T -UseMaximumSize -ErrorAction SilentlyContinue | Format-Volume -Confirm:$false\n#  New-Partition -DiskNumber 8 -DriveLetter L -UseMaximumSize -ErrorAction SilentlyContinue | Format-Volume -Confirm:$false\n\n  #Format drive with 64K block size, assigns Label and drive letter\n  Format-Volume -DriveLetter \"@@{Data_Drive_Letter}@@\" -FileSystem NTFS -NewFileSystemLabel \"@@{Data_Drive_Label}@@\" -Confirm:$false \n # Format-Volume -DriveLetter R -AllocationUnitSize 65536 -FileSystem NTFS -NewFileSystemLabel \"SQLBCK\" -Confirm:$false \n  #Format-Volume -DriveLetter G -AllocationUnitSize 65536 -FileSystem NTFS -NewFileSystemLabel \"DATA01\" -Confirm:$false \n  #Format-Volume -DriveLetter H -AllocationUnitSize 65536 -FileSystem NTFS -NewFileSystemLabel \"DATA02\" -Confirm:$false \n  #Format-Volume -DriveLetter I -AllocationUnitSize 65536 -FileSystem NTFS -NewFileSystemLabel \"TEMPDB01\" -Confirm:$false \n  #Format-Volume -DriveLetter J -AllocationUnitSize 65536 -FileSystem NTFS -NewFileSystemLabel \"TEMPDB02\" -Confirm:$false \n  #Format-Volume -DriveLetter T -AllocationUnitSize 65536 -FileSystem NTFS -NewFileSystemLabel \"TEMPDBLOG01\" -Confirm:$false \n  #Format-Volume -DriveLetter L -AllocationUnitSize 65536 -FileSystem NTFS -NewFileSystemLabel \"ULOG01\" -Confirm:$false \n\n  Write-Output \"Time taken: $((Get-Date).Subtract($start_time).seconds) Second(s)\"","script_type":"npsscript","type":""},"child_tasks_local_reference_list":[],"description":"","message_list":[],"name":"Initalize Disks","retries":"0","state":"ACTIVE","target_any_local_reference":{"kind":"app_service","name":"Windows Server 2016 VM"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"attrs":{"edges":[{"edge_type":"user_defined","from_task_reference":{"kind":"app_task","name":"Change CDROM Drive Letter"},"to_task_reference":{"kind":"app_task","name":"Initalize Disks"},"type":""},{"edge_type":"user_defined","from_task_reference":{"kind":"app_task","name":"Eject CDROM ISO"},"to_task_reference":{"kind":"app_task","name":"Change CDROM Drive Letter"},"type":""},{"edge_type":"user_defined","from_task_reference":{"kind":"app_task","name":"Initalize Disks"},"to_task_reference":{"kind":"app_task","name":"AD Domain Join"},"type":""}],"type":""},"child_tasks_local_reference_list":[{"kind":"app_task","name":"AD Domain Join"},{"kind":"app_task","name":"Change CDROM Drive Letter"},{"kind":"app_task","name":"Eject CDROM ISO"},{"kind":"app_task","name":"Initalize Disks"}],"description":"","message_list":[],"name":"b9592ed2_dag","retries":"0","state":"ACTIVE","target_any_local_reference":{"kind":"app_package","name":"Package1"},"timeout_secs":"0","type":"DAG","variable_list":[]}],"variable_list":[]},"type":"","uninstall_runbook":{"description":"","main_task_local_reference":{"kind":"app_task","name":"6a853ba8_dag"},"message_list":[],"name":"0bbbe2fc_runbook","state":"ACTIVE","task_definition_list":[{"attrs":{"edges":[],"type":""},"child_tasks_local_reference_list":[],"description":"","message_list":[],"name":"6a853ba8_dag","retries":"0","state":"ACTIVE","target_any_local_reference":{"kind":"app_package","name":"Package1"},"timeout_secs":"0","type":"DAG","variable_list":[]}],"variable_list":[]}},"service_local_reference_list":[{"kind":"app_service","name":"Windows Server 2016 VM"}],"type":"DEB","variable_list":[],"version":""}],"published_service_definition_list":[],"service_definition_list":[{"action_list":[{"critical":false,"description":"System action for creating an application","name":"action_create","runbook":{"description":"","main_task_local_reference":{"kind":"app_task","name":"b287ae69_dag"},"name":"0face391_runbook","task_definition_list":[{"attrs":{"edges":[],"type":""},"child_tasks_local_reference_list":[],"description":"","name":"b287ae69_dag","retries":"0","target_any_local_reference":{"kind":"app_service","name":"Windows Server 2016 VM"},"timeout_secs":"0","type":"DAG","variable_list":[]}],"variable_list":[]},"type":"system"},{"critical":false,"description":"System action for deleting an application. Deletes created VMs as well","name":"action_delete","runbook":{"description":"","main_task_local_reference":{"kind":"app_task","name":"c2fb786d_dag"},"name":"ca4c3889_runbook","task_definition_list":[{"attrs":{"edges":[],"type":""},"child_tasks_local_reference_list":[],"description":"","name":"c2fb786d_dag","retries":"0","target_any_local_reference":{"kind":"app_service","name":"Windows Server 2016 VM"},"timeout_secs":"0","type":"DAG","variable_list":[]}],"variable_list":[]},"type":"system"},{"critical":false,"description":"System action for restarting an application","name":"action_restart","runbook":{"description":"","main_task_local_reference":{"kind":"app_task","name":"31de2e41_dag"},"name":"3853badc_runbook","task_definition_list":[{"attrs":{"edges":[],"type":""},"child_tasks_local_reference_list":[],"description":"","name":"31de2e41_dag","retries":"0","target_any_local_reference":{"kind":"app_service","name":"Windows Server 2016 VM"},"timeout_secs":"0","type":"DAG","variable_list":[]}],"variable_list":[]},"type":"system"},{"critical":false,"description":"System action for starting an application","name":"action_start","runbook":{"description":"","main_task_local_reference":{"kind":"app_task","name":"e7204450_dag"},"name":"fe12a873_runbook","task_definition_list":[{"attrs":{"edges":[],"type":""},"child_tasks_local_reference_list":[],"description":"","name":"e7204450_dag","retries":"0","target_any_local_reference":{"kind":"app_service","name":"Windows Server 2016 VM"},"timeout_secs":"0","type":"DAG","variable_list":[]}],"variable_list":[]},"type":"system"},{"critical":false,"description":"System action for stopping an application","name":"action_stop","runbook":{"description":"","main_task_local_reference":{"kind":"app_task","name":"18bae529_dag"},"name":"f14d9f5d_runbook","task_definition_list":[{"attrs":{"edges":[],"type":""},"child_tasks_local_reference_list":[],"description":"","name":"18bae529_dag","retries":"0","target_any_local_reference":{"kind":"app_service","name":"Windows Server 2016 VM"},"timeout_secs":"0","type":"DAG","variable_list":[]}],"variable_list":[]},"type":"system"}],"depends_on_list":[],"description":"","name":"Windows Server 2016 VM","port_list":[],"singleton":false,"tier":"","variable_list":[]}],"substrate_definition_list":[{"action_list":[],"create_spec":{"availability_zone_reference":null,"backup_policy":null,"categories":"","cluster_reference":null,"name":"@@{calm_application_name}@@","resources":{"boot_config":{"boot_device":{"disk_address":{"adapter_type":"SCSI","device_index":0,"type":""},"type":""},"mac_address":"","type":""},"disk_list":[{"data_source_reference":null,"device_properties":{"device_type":"DISK","disk_address":{"adapter_type":"SCSI","device_index":1,"type":""},"type":""},"disk_size_mib":10240,"type":"","volume_group_reference":null},{"data_source_reference":{"kind":"image","name":"WinSrv2016-generalized-vDisk","type":"","uuid":"ff849a2e-8a5b-49e1-ae23-99a028acf55b"},"device_properties":{"device_type":"DISK","disk_address":{"adapter_type":"SCSI","device_index":0,"type":""},"type":""},"disk_size_mib":0,"type":"","volume_group_reference":null}],"gpu_list":[],"guest_customization":{"cloud_init":null,"sysprep":{"install_type":"PREPARED","type":"","unattend_xml":"<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<unattend xmlns=\"urn:schemas-microsoft-com:unattend\">\n    <settings pass=\"specialize\">\n        <component name=\"Microsoft-Windows-Shell-Setup\" processorArchitecture=\"amd64\" publicKeyToken=\"31bf3856ad364e35\" language=\"neutral\" versionScope=\"nonSxS\" xmlns:wcm=\"http:\/\/schemas.microsoft.com\/WMIConfig\/2002\/State\" xmlns:xsi=\"http:\/\/www.w3.org\/2001\/XMLSchema-instance\">\n            <ComputerName>@@{calm_application_name}@@<\/ComputerName>\n            <RegisteredOrganization>supernuc<\/RegisteredOrganization>\n            <RegisteredOwner>supernuc<\/RegisteredOwner>\n            <TimeZone>Central Standard Time<\/TimeZone>\n        <\/component>\n        <component name=\"Microsoft-Windows-International-Core\" processorArchitecture=\"amd64\" publicKeyToken=\"31bf3856ad364e35\" language=\"neutral\" versionScope=\"nonSxS\" xmlns:wcm=\"http:\/\/schemas.microsoft.com\/WMIConfig\/2002\/State\" xmlns:xsi=\"http:\/\/www.w3.org\/2001\/XMLSchema-instance\">\n            <InputLocale>en-US<\/InputLocale>\n            <SystemLocale>en-US<\/SystemLocale>\n            <UILanguage>en-US<\/UILanguage>\n            <UserLocale>en-US<\/UserLocale>\n        <\/component>\n    <\/settings>\n    <settings pass=\"oobeSystem\">\n        <component name=\"Microsoft-Windows-International-Core\" processorArchitecture=\"amd64\" publicKeyToken=\"31bf3856ad364e35\" language=\"neutral\" versionScope=\"nonSxS\" xmlns:wcm=\"http:\/\/schemas.microsoft.com\/WMIConfig\/2002\/State\" xmlns:xsi=\"http:\/\/www.w3.org\/2001\/XMLSchema-instance\">\n            <InputLocale>en-US<\/InputLocale>\n            <SystemLocale>en-US<\/SystemLocale>\n            <UILanguage>en-US<\/UILanguage>\n            <UserLocale>en-US<\/UserLocale>\n        <\/component>\n        <component name=\"Microsoft-Windows-Shell-Setup\" processorArchitecture=\"amd64\" publicKeyToken=\"31bf3856ad364e35\" language=\"neutral\" versionScope=\"nonSxS\" xmlns:wcm=\"http:\/\/schemas.microsoft.com\/WMIConfig\/2002\/State\" xmlns:xsi=\"http:\/\/www.w3.org\/2001\/XMLSchema-instance\">\n            <OOBE>\n                <HideEULAPage>true<\/HideEULAPage>\n            <\/OOBE>\n            <UserAccounts>\n                <AdministratorPassword>\n                    <Value>@@{Local_Admin_Password}@@<\/Value>\n                    <PlainText>true<\/PlainText>\n                <\/AdministratorPassword>\n            <\/UserAccounts>\n        <\/component>\n    <\/settings>\n    <settings pass=\"generalize\">\n        <component name=\"Microsoft-Windows-PnpSysprep\" processorArchitecture=\"amd64\" publicKeyToken=\"31bf3856ad364e35\" language=\"neutral\" versionScope=\"nonSxS\" xmlns:wcm=\"http:\/\/schemas.microsoft.com\/WMIConfig\/2002\/State\" xmlns:xsi=\"http:\/\/www.w3.org\/2001\/XMLSchema-instance\">\n            <PersistAllDeviceInstalls>true<\/PersistAllDeviceInstalls>\n        <\/component>\n    <\/settings>\n<\/unattend>"},"type":""},"guest_tools":null,"hardware_clock_timezone":"","memory_size_mib":4096,"nic_list":[{"ip_endpoint_list":[],"mac_address":"","network_function_chain_reference":null,"network_function_nic_type":"INGRESS","nic_type":"NORMAL_NIC","subnet_reference":{"kind":"subnet","name":"","type":"","uuid":"798645b0-797e-48a5-8560-2d45bc3c190a"},"type":""}],"num_sockets":2,"num_vcpus_per_socket":1,"parent_reference":null,"power_state":"ON","serial_port_list":[],"type":""},"type":""},"description":"","editables":{"create_spec":{"resources":{"disk_list":{"1":{"disk_size_mib":true}},"memory_size_mib":true,"nic_list":{},"num_sockets":true,"serial_port_list":{}}}},"name":"WinSrv16","os_type":"Windows","readiness_probe":{"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","connection_port":5985,"connection_type":"POWERSHELL","delay_secs":"60","disable_readiness_probe":false,"login_credential_local_reference":{"kind":"app_credential","name":"Windows Local Admin"}},"type":"AHV_VM","variable_list":[]}],"type":"USER"}},"status":{}}